<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fraud Detector - Customer Acquisition to Loyalty</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    
    .header {
      text-align: center;
      color: white;
      margin-bottom: 30px;
    }
    
    .header h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
    }
    
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .stat-card h2 {
      font-size: 2.5rem;
      color: #2563eb;
      margin-bottom: 5px;
    }
    
    .stat-card p {
      color: #666;
      font-size: 0.9rem;
    }
    
    .card {
      background: white;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .card h2 {
      color: #1e293b;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .badge {
      font-size: 0.75rem;
      padding: 4px 8px;
      border-radius: 4px;
      background: #e0e7ff;
      color: #3730a3;
    }
    
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: #374151;
    }
    
    input, select {
      width: 100%;
      padding: 10px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 14px;
    }
    
    button {
      background: #2563eb;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.3s;
    }
    
    button:hover {
      background: #1e40af;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #e5e7eb;
    }
    
    th {
      background: #f8fafc;
      font-weight: 600;
      color: #1e293b;
    }
    
    .priority-high { color: #ef4444; font-weight: 600; }
    .priority-medium { color: #f59e0b; font-weight: 600; }
    .priority-low { color: #3b82f6; font-weight: 600; }
    
    .risk-high { background: #fee2e2; color: #991b1b; padding: 4px 12px; border-radius: 12px; font-size: 0.875rem; font-weight: 600; }
    .risk-medium { background: #fef3c7; color: #92400e; padding: 4px 12px; border-radius: 12px; font-size: 0.875rem; font-weight: 600; }
    .risk-low { background: #d1fae5; color: #065f46; padding: 4px 12px; border-radius: 12px; font-size: 0.875rem; font-weight: 600; }
    
    .segment-badge {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 0.875rem;
      font-weight: 600;
    }
    
    .segment-champions { background: #fce7f3; color: #9f1239; }
    .segment-loyal { background: #dbeafe; color: #1e40af; }
    .segment-atrisk { background: #fef3c7; color: #92400e; }
    .segment-lost { background: #fee2e2; color: #991b1b; }
    
    .message {
      padding: 12px;
      border-radius: 6px;
      margin-top: 10px;
      display: none;
    }
    
    .message.success {
      background: #d1fae5;
      color: #065f46;
      display: block;
    }
    
    .message.error {
      background: #fee2e2;
      color: #991b1b;
      display: block;
    }
    
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    
    .chart-container {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    canvas {
      max-height: 300px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üè• Medical Fraud Detector</h1>
    </div>
    
    <div class="stats">
      <div class="stat-card">
        <h2 id="totalLeads">0</h2>
        <p>üìã Total Leads</p>
      </div>
      <div class="stat-card">
        <h2 id="totalClaims">0</h2>
        <p>üè• Medical Claims</p>
      </div>
      <div class="stat-card">
        <h2 id="totalCustomers">0</h2>
        <p>üë• Customers</p>
      </div>
      <div class="stat-card">
        <h2 id="highRiskClaims">0</h2>
        <p>‚ö†Ô∏è High Risk Claims</p>
      </div>
    </div>
    
    <div class="card">
      <h2>1Ô∏è‚É£ Lead Capture & Qualification </h2>
      <form id="leadForm">
        <div class="form-grid">
          <div class="form-group">
            <label>Name *</label>
            <input type="text" id="leadName" required>
          </div>
          <div class="form-group">
            <label>Email *</label>
            <input type="email" id="leadEmail" required>
          </div>
          <div class="form-group">
            <label>Budget ($)</label>
            <input type="number" id="leadBudget" value="10000">
          </div>
          <div class="form-group">
            <label>Source</label>
            <select id="leadSource">
              <option value="website">Website</option>
              <option value="referral">Referral</option>
              <option value="direct">Direct</option>
            </select>
          </div>
        </div>
        <button type="submit">Submit Lead</button>
        <div id="leadMessage" class="message"></div>
      </form>
      
      <h3 style="margin-top: 25px;">‚ö° Next Leads to Contact</h3>
      <table>
        <thead>
          <tr>
            <th>Priority</th>
            <th>Name</th>
            <th>Email</th>
            <th>Budget</th>
            <th>Source</th>
            <th>Stage</th>
          </tr>
        </thead>
        <tbody id="leadsTable">
          <tr><td colspan="6">Loading...</td></tr>
        </tbody>
      </table>
    </div>
    
    <div class="card">
      <h2>2Ô∏è‚É£ Medical Fraud Detection</h2>
      <form id="claimForm">
        <div class="form-grid">
          <div class="form-group">
            <label>Patient Name *</label>
            <input type="text" id="patientName" required>
          </div>
          <div class="form-group">
            <label>Provider Name *</label>
            <input type="text" id="providerName" required>
          </div>
          <div class="form-group">
            <label>Claim Amount ($) *</label>
            <input type="number" id="claimAmount" required>
          </div>
          <div class="form-group">
            <label>Procedures (comma-separated)</label>
            <input type="text" id="procedures" placeholder="99213, 93000">
          </div>
        </div>
        <button type="submit">Submit Claim (Fraud Analysis)</button>
        <div id="claimMessage" class="message"></div>
      </form>
      
      <h3 style="margin-top: 25px;">üö® All Claims (Sorted by Fraud Score)</h3>
      <table>
        <thead>
          <tr>
            <th>Patient</th>
            <th>Provider</th>
            <th>Amount</th>
            <th>Fraud Score</th>
            <th>Risk Level</th>
            <th>Date</th>
          </tr>
        </thead>
        <tbody id="claimsTable">
          <tr><td colspan="6">Loading...</td></tr>
        </tbody>
      </table>
    </div>
    
    <div class="card">
      <h2>3Ô∏è‚É£ Business Metrics Dashboard </h2>
      <div style="display: flex; gap: 10px; margin-bottom: 20px;">
        <button onclick="calculateRFM()">Calculate RFM</button>
        <button onclick="calculateCLV()">Calculate CLV</button>
        <button onclick="calculateNPS()">Calculate NPS</button>
      </div>
      
      <div id="metricsResults"></div>
    </div>
    
    <div class="card">
      <h2>4Ô∏è‚É£ Operations & Referral Network </h2>
      <button onclick="loadChannels()" style="margin-bottom: 15px;">Load Channel Performance</button>
      <button onclick="loadReferrals()">Analyze Referral Network</button>
      
      <div id="operationsResults"></div>
    </div>
    
    <div class="charts-grid">
      <div class="chart-container">
        <h3>üìä Fraud Score Distribution</h3>
        <canvas id="fraudChart"></canvas>
      </div>
      <div class="chart-container">
        <h3>üéØ Sales Funnel</h3>
        <canvas id="funnelChart"></canvas>
      </div>
    </div>
  </div>
  
  <script>
    const API = 'http://localhost:3002/api';
    
    // Load dashboard
    async function loadDashboard() {
      try {
        const res = await fetch(`${API}/dashboard`);
        const data = await res.json();
        
        if (data.success) {
          document.getElementById('totalLeads').textContent = data.stats.totalLeads;
          document.getElementById('totalClaims').textContent = data.stats.totalClaims;
          document.getElementById('totalCustomers').textContent = data.stats.totalCustomers;
          document.getElementById('highRiskClaims').textContent = data.stats.highRiskClaims;
        }
        
        await loadLeads();
        await loadClaims();
        await loadCharts();
      } catch (error) {
        console.error('Error loading dashboard:', error);
      }
    }
    
    // Load leads (Priority Queue)
    async function loadLeads() {
      try {
        const res = await fetch(`${API}/leads`);
        const data = await res.json();
        
        const tbody = document.getElementById('leadsTable');
        if (data.leads && data.leads.length > 0) {
          tbody.innerHTML = data.leads.map(lead => {
            const priority = lead.priority;
            let priorityClass = 'priority-low', label = 'Low';
            if (priority <= 30) { priorityClass = 'priority-high'; label = 'High'; }
            else if (priority <= 60) { priorityClass = 'priority-medium'; label = 'Medium'; }
            
            return `
              <tr>
                <td class="${priorityClass}">${label} (${priority})</td>
                <td>${lead.element.name}</td>
                <td>${lead.element.email}</td>
                <td>$${(lead.element.budget || 0).toLocaleString()}</td>
                <td>${lead.element.source}</td>
                <td>${lead.element.stage}</td>
              </tr>
            `;
          }).join('');
        } else {
          tbody.innerHTML = '<tr><td colspan="6">No leads yet. Submit one above!</td></tr>';
        }
      } catch (error) {
        console.error('Error loading leads:', error);
      }
    }
    
    // Load claims
    async function loadClaims() {
      try {
        const res = await fetch(`${API}/claims`);
        const data = await res.json();
        
        const tbody = document.getElementById('claimsTable');
        if (data.claims && data.claims.length > 0) {
          tbody.innerHTML = data.claims.map(claim => `
            <tr>
              <td>${claim.patientName}</td>
              <td>${claim.providerName}</td>
              <td>$${claim.amount.toLocaleString()}</td>
              <td><strong>${claim.fraudScore}</strong></td>
              <td><span class="risk-${claim.riskLevel.toLowerCase()}">${claim.riskLevel}</span></td>
              <td>${new Date(claim.submittedAt).toLocaleDateString()}</td>
            </tr>
          `).join('');
        } else {
          tbody.innerHTML = '<tr><td colspan="6">No claims yet</td></tr>';
        }
      } catch (error) {
        console.error('Error loading claims:', error);
      }
    }
    
    // Load charts
    async function loadCharts() {
      try {
        // Get claims data
        const claimsRes = await fetch(`${API}/claims`);
        const claimsData = await claimsRes.json();
        
        // Get leads data for funnel
        const leadsRes = await fetch(`${API}/leads`);
        const leadsData = await leadsRes.json();
        
        // Fraud score distribution chart
        if (claimsData.claims && claimsData.claims.length > 0) {
          const scores = claimsData.claims.map(c => c.fraudScore);
          const labels = claimsData.claims.map((c, i) => c.patientName || `Claim ${i + 1}`);
          
          const ctx1 = document.getElementById('fraudChart');
          if (ctx1) {
            new Chart(ctx1, {
              type: 'bar',
              data: {
                labels: labels,
                datasets: [{
                  label: 'Fraud Score',
                  data: scores,
                  backgroundColor: scores.map(s => 
                    s >= 50 ? 'rgba(239, 68, 68, 0.8)' : 
                    s >= 30 ? 'rgba(251, 191, 36, 0.8)' : 
                    'rgba(16, 185, 129, 0.8)'
                  ),
                  borderColor: scores.map(s => 
                    s >= 50 ? 'rgb(239, 68, 68)' : 
                    s >= 30 ? 'rgb(251, 191, 36)' : 
                    'rgb(16, 185, 129)'
                  ),
                  borderWidth: 2
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: { 
                  legend: { display: false },
                  title: {
                    display: true,
                    text: 'Fraud Risk Analysis'
                  }
                },
                scales: { 
                  y: { 
                    beginAtZero: true, 
                    max: 100,
                    title: {
                      display: true,
                      text: 'Fraud Score'
                    }
                  } 
                }
              }
            });
          }
        }
        
        // Sales funnel chart
        const ctx2 = document.getElementById('funnelChart');
        if (ctx2) {
          // Count leads by stage
          const stages = { prospect: 0, qualified: 0, customer: 0, loyal: 0 };
          if (leadsData.leads) {
            leadsData.leads.forEach(lead => {
              const stage = lead.element.stage || 'prospect';
              stages[stage] = (stages[stage] || 0) + 1;
            });
          }
          
          new Chart(ctx2, {
            type: 'bar',
            data: {
              labels: ['Prospect', 'Qualified', 'Customer', 'Loyal'],
              datasets: [{
                label: 'Number of Leads',
                data: [stages.prospect, stages.qualified, stages.customer, stages.loyal],
                backgroundColor: [
                  'rgba(99, 102, 241, 0.8)',
                  'rgba(59, 130, 246, 0.8)',
                  'rgba(16, 185, 129, 0.8)',
                  'rgba(236, 72, 153, 0.8)'
                ],
                borderColor: [
                  'rgb(99, 102, 241)',
                  'rgb(59, 130, 246)',
                  'rgb(16, 185, 129)',
                  'rgb(236, 72, 153)'
                ],
                borderWidth: 2
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: true,
              plugins: { 
                legend: { display: false },
                title: {
                  display: true,
                  text: 'Customer Acquisition Funnel'
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: { stepSize: 1 },
                  title: {
                    display: true,
                    text: 'Count'
                  }
                }
              }
            }
          });
        }
      } catch (error) {
        console.error('Error loading charts:', error);
      }
    }
    
    // Submit lead
    document.getElementById('leadForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const lead = {
        name: document.getElementById('leadName').value,
        email: document.getElementById('leadEmail').value,
        budget: parseInt(document.getElementById('leadBudget').value),
        source: document.getElementById('leadSource').value
      };
      
      try {
        const res = await fetch(`${API}/leads`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(lead)
        });
        
        const data = await res.json();
        const msg = document.getElementById('leadMessage');
        
        if (data.success) {
          msg.className = 'message success';
          msg.textContent = `‚úÖ ${data.message} Priority: ${data.score}`;
          document.getElementById('leadForm').reset();
          loadDashboard();
        } else {
          msg.className = 'message error';
          msg.textContent = `‚ùå ${data.message}`;
        }
        
        setTimeout(() => msg.style.display = 'none', 3000);
      } catch (error) {
        console.error('Error:', error);
      }
    });
    
    // Submit claim
    document.getElementById('claimForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const procedures = document.getElementById('procedures').value
        .split(',')
        .map(p => p.trim())
        .filter(p => p);
      
      const claim = {
        patientName: document.getElementById('patientName').value,
        providerName: document.getElementById('providerName').value,
        amount: parseFloat(document.getElementById('claimAmount').value),
        procedures
      };
      
      try {
        const res = await fetch(`${API}/claims`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(claim)
        });
        
        const data = await res.json();
        const msg = document.getElementById('claimMessage');
        
        if (data.success) {
          msg.className = 'message success';
          msg.textContent = `‚úÖ Claim analyzed! Fraud Score: ${data.fraudScore} | Risk: ${data.riskLevel}`;
          document.getElementById('claimForm').reset();
          loadDashboard();
        } else {
          msg.className = 'message error';
          msg.textContent = `‚ùå Error submitting claim`;
        }
        
        setTimeout(() => msg.style.display = 'none', 3000);
      } catch (error) {
        console.error('Error:', error);
      }
    });
    
    // Calculate RFM
    async function calculateRFM() {
      try {
        const res = await fetch(`${API}/rfm`, { method: 'POST' });
        const data = await res.json();
        
        const div = document.getElementById('metricsResults');
        if (data.customers && data.customers.length > 0) {
          div.innerHTML = `
            <h3>üéØ RFM Segmentation Results</h3>
            <table>
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Orders</th>
                  <th>Total Spent</th>
                  <th>R-F-M</th>
                  <th>Segment</th>
                </tr>
              </thead>
              <tbody>
                ${data.customers.map(c => {
                  const segClass = c.segment.toLowerCase().replace(/ /g, '');
                  return `
                    <tr>
                      <td>${c.name}</td>
                      <td>${c.totalOrders}</td>
                      <td>$${c.totalSpent.toFixed(2)}</td>
                      <td>${c.recencyScore}-${c.frequencyScore}-${c.monetaryScore}</td>
                      <td><span class="segment-badge segment-${segClass}">${c.segment}</span></td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          `;
        } else {
          div.innerHTML = '<p>No customers with orders yet</p>';
        }
      } catch (error) {
        console.error('Error:', error);
      }
    }
    
    // Calculate CLV
    async function calculateCLV() {
      try {
        const res = await fetch(`${API}/clv`, { method: 'POST' });
        const data = await res.json();
        
        const div = document.getElementById('metricsResults');
        if (data.customers && data.customers.length > 0) {
          div.innerHTML = `
            <h3>üíé Customer Lifetime Value (CLV)</h3>
            <p><strong>Average CLV: $${data.avgCLV.toFixed(2)}</strong></p>
            <table>
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Avg Order</th>
                  <th>Frequency</th>
                  <th>CLV (36 months)</th>
                </tr>
              </thead>
              <tbody>
                ${data.customers.map(c => `
                  <tr>
                    <td>${c.name}</td>
                    <td>$${(c.avgOrderValue || 0).toFixed(2)}</td>
                    <td>${(c.purchaseFrequency || 0).toFixed(2)}/month</td>
                    <td><strong>$${(c.clv || 0).toFixed(2)}</strong></td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
        }
      } catch (error) {
        console.error('Error:', error);
      }
    }
    
    // Calculate NPS
    async function calculateNPS() {
      try {
        const res = await fetch(`${API}/nps`, { method: 'POST' });
        const data = await res.json();
        
        const div = document.getElementById('metricsResults');
        div.innerHTML = `
          <h3>‚≠ê Net Promoter Score (NPS)</h3>
          <div style="text-align: center; padding: 20px; background: #f8fafc; border-radius: 8px;">
            <h2 style="font-size: 3rem; color: #2563eb; margin-bottom: 10px;">${data.nps}</h2>
            <p style="color: #666;">Promoters: ${data.promoters} | Passives: ${data.passives} | Detractors: ${data.detractors}</p>
          </div>
        `;
      } catch (error) {
        console.error('Error:', error);
      }
    }
    
    // Load channels
    async function loadChannels() {
      try {
        const res = await fetch(`${API}/channels`);
        const data = await res.json();
        
        const div = document.getElementById('operationsResults');
        if (data.channels && data.channels.length > 0) {
          div.innerHTML = `
            <h3>üìä Channel Performance</h3>
            <table>
              <thead>
                <tr>
                  <th>Channel</th>
                  <th>Orders</th>
                  <th>Revenue</th>
                  <th>Avg Order Value</th>
                </tr>
              </thead>
              <tbody>
                ${data.channels.map(ch => `
                  <tr>
                    <td><strong>${ch._id}</strong></td>
                    <td>${ch.totalOrders}</td>
                    <td>$${ch.totalRevenue.toFixed(2)}</td>
                    <td>$${ch.avgOrderValue.toFixed(2)}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
        }
      } catch (error) {
        console.error('Error:', error);
      }
    }
    
    // Load referrals
    async function loadReferrals() {
      try {
        const res = await fetch(`${API}/referrals`);
        const data = await res.json();
        
        const div = document.getElementById('operationsResults');
        if (data.topReferrers && data.topReferrers.length > 0) {
          div.innerHTML = `
            <h3>üîó Top Referrers</h3>
            <table>
              <thead>
                <tr>
                  <th>Rank</th>
                  <th>Customer ID</th>
                  <th>Referral Count</th>
                </tr>
              </thead>
              <tbody>
                ${data.topReferrers.map((r, i) => `
                  <tr>
                    <td><strong>${i + 1}</strong></td>
                    <td>${r.vertex}</td>
                    <td>${r.degree}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          `;
        } else {
          div.innerHTML = '<p>No referral data available</p>';
        }
      } catch (error) {
        console.error('Error:', error);
      }
    }
    
    // Initialize
    loadDashboard();
  </script>
</body>
</html>
